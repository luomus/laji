<div class="table-wrapper">
  <table>
    <tr>
      @for (colIdx of selectedColumns; track colIdx; let idx = $index) {
        <th
          draggable="true"
          (dragstart)="onTableHeaderDragStart($event, idx)"
          (dragend)="onTableHeaderDragEnd($event)"
          (dragover)="onTableHeaderDragOver($event)"
          (drop)="onTableHeaderDrop($event)"
          #headerRef
          >
          <span class="header-contents">
            {{ columns[colIdx].title }}
            <div class="d-flex flex-row flex-nowrap">
              @if (columns[colIdx].sortable === undefined || columns[colIdx].sortable) {
                <button
                  class="sort-btn mr-2"
              [ngClass]="{
                'sort-btn mr-2': true,
                'sorted': colSortType(colIdx) !== 'NONE'
              }"
                  (click)="onToggleSort(colIdx)"
                  >
                  {{ getSortBtnChar(colIdx) }}
                </button>
              }
              @if (columns[colIdx].unselectable === undefined || columns[colIdx].unselectable) {
                <button
                  class="unselect-col-btn"
                  (click)="onUnselectColumn(colIdx)"
                  >
                  x
                </button>
              }
            </div>
          </span>
          <span class="col-separator" (mousedown)="onResizeMouseDown($event)"></span>
        </th>
      }
      @if (columns.length > selectedColumns.length) {
        <th>
          <input [attr.list]="'unselected-columns-' + uid" name="add-column" placeholder="Add column..." (input)="onAddColumn($any($event))" />
          <datalist [id]="'unselected-columns-' + uid">
            @for (colIdx of unselectedColumns; track colIdx) {
              <option [value]="colIdx">
                {{ columns[colIdx].title }}
              </option>
            }
          </datalist>
        </th>
      }
    </tr>
    @if (!loading) {
      @for (row of rows; track row; let rowIdx = $index) {
        <tr>
          @for (colIdx of selectedColumns; track colIdx) {
            <td #rowRef>
              @if (columns[colIdx]; as col) {
                @if (columnHasTemplate(col)) {
                  <ng-container
                *ngTemplateOutlet="col.cellTemplate;
                context: hasProp(col)
                  ? { $implicit: row, col, rowIdx, colIdx, prop: getNestedValue(row, $any(col).prop) }
                  : { $implicit: row, col, rowIdx, colIdx }"
                  ></ng-container>
                }
                @if (!columnHasTemplate(col)) {
                  {{ getNestedValue(row, col.prop) }}
                }
              }
            </td>
          }
        </tr>
      }
    } @else {
      @for (i of [].constructor(ghostCount); track i; let idx = $index) {
        <tr>
          @for (_ of selectedColumns; track _) {
            <td class="cell-ghost"><span></span></td>
          }
        </tr>
      }
    }
    <tr></tr>
  </table>
</div>

<lu-datatable-paginator [totalPages]="totalPages" [currentPageIdx]="currentPageIdx" (pageChange)="onPageChange($event)"></lu-datatable-paginator>


<div class="table-wrapper">
  <table>
    <tr>
      <th
        *ngFor="let colIdx of selectedColumns; let idx = index"
        draggable="true"
        (dragstart)="onTableHeaderDragStart($event, idx)"
        (dragend)="onTableHeaderDragEnd($event)"
        (dragover)="onTableHeaderDragOver($event)"
        (drop)="onTableHeaderDrop($event)"
        #headerRef
      >
        <span class="header-contents">
          {{ columns[colIdx].title }} 
          <div class="d-flex flex-row flex-nowrap">
            <button
              *ngIf="columns[colIdx].sortable === undefined || columns[colIdx].sortable"
              class="sort-btn mr-2"
              [ngClass]="{
                'sort-btn mr-2': true,
                'sorted': colSortType(colIdx) !== 'NONE'
              }"
              (click)="onToggleSort(colIdx)">
              {{ getSortBtnChar(colIdx) }}
            </button>
            <button class="unselect-col-btn" (click)="onUnselectColumn(colIdx)">x</button>
          </div>
        </span>
        <span class="col-separator" (mousedown)="onResizeMouseDown($event)"></span>
      </th>
      <th *ngIf="columns.length > selectedColumns.length">
        <input [attr.list]="'unselected-columns-' + uid" name="add-column" placeholder="Add column..." (input)="onAddColumn($event)" />
        <datalist [id]="'unselected-columns-' + uid">
          <option *ngFor="let colIdx of unselectedColumns" [value]="colIdx">
            {{ columns[colIdx].title }}
          </option>
        </datalist>
      </th>
    </tr>
    <ng-container *ngIf="!loading else rowGhosts">
      <tr *ngFor="let row of rows">
        <td *ngFor="let colIdx of selectedColumns" #rowRef>
          <ng-container *ngIf="columnHasTemplate(columns[colIdx]); else defaultTemplate">
            <ng-container
              *ngTemplateOutlet="columns[colIdx]['cellTemplate'];
              context: columns[colIdx].prop
                ? { $implicit: row, prop: getNestedValue(row, columns[colIdx]['prop']) }
                : { $implicit: row }"
            ></ng-container>
          </ng-container>
          <ng-template #defaultTemplate>
            {{ getNestedValue(row, columns[colIdx]['prop']) }}
          </ng-template>
        </td>
      </tr>
    </ng-container>
    <tr></tr>
  </table>
</div>

<ul *ngIf="totalPages > 1" class="paginator">
  <ng-container *ngIf="totalPages <= 7; else truncatedPaginator">
    <li *ngFor="let i of [].constructor(totalPages); let idx = index" (click)="onChangePage(idx)">
      {{ idx }}
    </li>
  </ng-container>
</ul>

<ng-template #truncatedPaginator>
  <ng-container *ngIf="currentPageIdx < 4">
    <li (click)="onChangePage(0)" [ngClass]="{active: currentPageIdx === 0}">1</li>
    <li (click)="onChangePage(1)" [ngClass]="{active: currentPageIdx === 1}">2</li>
    <li (click)="onChangePage(2)" [ngClass]="{active: currentPageIdx === 2}">3</li>
    <li (click)="onChangePage(3)" [ngClass]="{active: currentPageIdx === 3}">4</li>
    <li (click)="onChangePage(4)">5</li>
    <li class="three-dots">...</li>
    <li (click)="onChangePage(totalPages - 1)">{{ totalPages }}</li>
  </ng-container>
  <ng-container *ngIf="currentPageIdx >= 4 && currentPageIdx <= totalPages - 5">
    <li (click)="onChangePage(0)">1</li>
    <li class="three-dots">...</li>
    <li (click)="onChangePage(currentPageIdx - 1)">{{ currentPageIdx }}</li>
    <li (click)="onChangePage(currentPageIdx)" class="active">{{ currentPageIdx + 1 }}</li>
    <li (click)="onChangePage(currentPageIdx + 1)">{{ currentPageIdx + 2 }}</li>
    <li class="three-dots">...</li>
    <li (click)="onChangePage(totalPages - 1)">{{ totalPages }}</li>
  </ng-container>
  <ng-container *ngIf="currentPageIdx > totalPages - 5">
    <li (click)="onChangePage(0)">{{ 1 }}</li>
    <li class="three-dots">...</li>
    <li (click)="onChangePage(totalPages - 5)">{{ totalPages - 4 }}</li>
    <li (click)="onChangePage(totalPages - 4)" [ngClass]="{active: currentPageIdx === totalPages - 4}">{{ totalPages - 3 }}</li>
    <li (click)="onChangePage(totalPages - 3)" [ngClass]="{active: currentPageIdx === totalPages - 3}">{{ totalPages - 2 }}</li>
    <li (click)="onChangePage(totalPages - 2)" [ngClass]="{active: currentPageIdx === totalPages - 2}">{{ totalPages - 1 }}</li>
    <li (click)="onChangePage(totalPages - 1)" [ngClass]="{active: currentPageIdx === totalPages - 1}">{{ totalPages }}</li>
  </ng-container>
</ng-template>

<ng-template #rowGhosts>
  <tr *ngFor="let i of [].constructor(ghostCount); let idx = index">
    <td *ngFor="let _ of selectedColumns" class="cell-ghost"><span></span></td>
  </tr>
</ng-template>

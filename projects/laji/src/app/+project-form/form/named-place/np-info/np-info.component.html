<div class="np-info-container" [ngClass]="{'hidden': namedPlace === undefined}">
  <div class="hidden-xs hidden-sm hidden-md" #infoBox>
    <ng-template [ngTemplateOutlet]="contentTemplate" [ngTemplateOutletContext]="{isModal: false}"></ng-template>
  </div>

  <lu-modal #infoModal>
    @if (modalIsVisible) {
      <ng-template [ngTemplateOutlet]="contentTemplate" [ngTemplateOutletContext]="{isModal: true}"></ng-template>
    }
  </lu-modal>

  <ng-template #contentTemplate let-isModal="isModal">
    <div class="np-info">
      <div class="d-flex flex-row justify-between items-end mb-4 np-info-header"
        lajiFormOption="options.namedPlaceOptions.allowAddingPublic options.printType options.namedPlaceOptions.printLabel">
        <h3 [luTooltip]="'MNP.name' | label">{{ namedPlace?.name }}</h3>
        @if (documentForm.options?.printType || (allowEdit && editButtonVisible)) {
          <div lajiFormOption="options.printType options.namedPlaceOptions.printLabel">
            @if (documentForm.options?.printType) {
              <span>
                <a class="btn btn-sm btn-default"
                  target="_blank"
                [routerLink]="['./', namedPlace.id, 'print'] | localize">{{ documentForm.options?.namedPlaceOptions?.printLabel || 'np.print' | translate }}</a>
              </span>
            }
            @if (allowEdit && editButtonVisible) {
              <ng-container lajiFormOption="options.namedPlaceOptions.allowAddingPublic">
                <lu-button (click)="editClick()" id="np-edit">{{ 'np.edit' | translate }}</lu-button>
                <div class="d-inline-block">
                  <lu-button (click)="deleteClick()" [disabled]="!canDelete" id="np-delete">{{ 'np.delete' | translate }}</lu-button>
                  @if (!canDelete) {
                    <laji-info>{{ 'np.delete.disabled.hasDocs' | translate }}</laji-info>
                  }
                </div>
              </ng-container>
            }
          </div>
        }
      </div>
      <fieldset>
        <laji-np-info-map [visible]="(isModal && modalIsVisible) || $any(infoBox)?.nativeElement?.offsetParent !== null"
        [namedPlace]="namedPlace"></laji-np-info-map>
        @for (i of listItems; track i) {
          <div lajiFormOption="options.namedPlaceOptions.infoFields">
            <laji-np-info-row class="d-block mb-3" [title]="i.title" [value]="i.value" [pipe]="i.pipe"></laji-np-info-row>
          </div>
        }
        @if (namedPlace?.prepopulatedDocument?.gatheringEvent?.dateBegin) {
          <laji-np-info-row class="d-block mb-3"
            [title]="documentForm.options?.namedPlaceOptions?.lastCensusLabel || 'lastCensus' | translate"
            lajiFormOption="documentForm.options.namedPlaceOptions.lastCensusLabel"
          [value]="namedPlace.prepopulatedDocument?.gatheringEvent?.dateBegin"></laji-np-info-row>
        }
        <div *lajiLoggedIn="false" style="margin-top: 20px;">
          <strong>
            @if (formReservable) {
              {{ 'np.infoNoLoginReservable' | translate }}
            } @else {
              {{ 'np.infoNoLogin' | translate }}
            }
          </strong>
        </div>
        <div *lajiLoggedIn="true" class="button-container"
          lajiFormOption="options.namedPlaceOptions.reservationUntil options.namedPlaceOptions.useLabel options.namedPlaceOptions.releaseLabel options.namedPlaceOptions.reservableLabel">
          @switch (useButton) {
            @case ('usable') {
              <div class="row-container">
                <lu-button [role]="'primary'"
                  (click)="useClick()"
                  [disabled]="useDisabled"
                  lajiFormOption="options.namedPlaceOptions.useLabel"
                >{{ useLabel || documentForm.options?.namedPlaceOptions?.useLabel || 'np.defaultUse' | translate }}</lu-button>
              </div>
            }
            @case ('reservedByYou') {
              <div class="row-container">
                <lu-button [disabled]="loading" (click)="useClick()" lajiFormOption="options.namedPlaceOptions.useLabel">
                {{ documentForm.options?.namedPlaceOptions?.useLabel || 'np.defaultUse' | translate }}</lu-button>
                <lu-button [disabled]="loading" (click)="releaseButtonClick.emit(namedPlace)" lajiFormOption="options.namedPlaceOptions.releaseLabel">
                {{ documentForm.options?.namedPlaceOptions?.releaseLabel || 'np.release' | translate }}</lu-button>
              </div>
            }
            @case ('nouse') {
              <laji-request [collectionId]="collectionId"
                [disableDescription]="true"
              ></laji-request>
            }
            @case ('reservable') {
              <div class="row-container">
                <lu-button [disabled]="loading" (click)="reserveButtonClick.emit(namedPlace)" lajiFormOption="options.namedPlaceOptions.reservableLabel">
                {{ documentForm.options?.namedPlaceOptions?.reservableLabel || 'np.reserve' | translate }}</lu-button>
              </div>
            }
            @case ('reservedByOther') {
              <div class="row-container">
                <lu-button [disabled]="true" lajiFormOption="options.namedPlaceOptions.reservedLabel">
                {{ documentForm.options?.namedPlaceOptions?.reservedLabel || 'np.reserved' | translate }}</lu-button>
                @if (formRights.admin) {
                  <div class="key">
                    <strong>Varauksen omistaja:</strong>
                  </div>
                  <div class="value">
                    {{ namedPlace.reserve!.reserver | label }}
                  </div>
                  <lu-button [disabled]="loading" (click)="releaseButtonClick.emit(namedPlace)" lajiFormOption="options.namedPlaceOptions.releaseLabel">
                  {{ documentForm.options?.namedPlaceOptions?.releaseLabel || 'np.release' | translate }} (admin)</lu-button>
                }
              </div>
            }
          }
        </div>
        @if (formRights.admin && documentForm.options?.namedPlaceOptions?.adminShowCopyLink) {
          <div
            lajiFormOption="options.namedPlaceOptions.adminShowCopyLink"
            class="button-container">
            <div class="row-container">
              <lu-button (click)="copyLink()">{{ 'np.copyAddress' | translate }}</lu-button>
            </div>
          </div>
        }
      </fieldset>
      <div class="own-submissions-container" *lajiLoggedIn="true"
        lajiFormOption="options.namedPlaceOptions.earlierLabel options.namedPlaceOptions.myEarlierLabel">
        <strong>{{
          formRights.admin
          ? documentForm.options?.namedPlaceOptions?.earlierLabel || ('np.earlier' | translate)
          : documentForm.options?.namedPlaceOptions?.myEarlierLabel || ('np.myEarlier' | translate)
        }}</strong>:
        <laji-own-submissions
          [actions]="formRights.admin ? ['edit', 'view', 'delete'] : ['edit', 'view']"
          [columns]="['dateObserved', 'observer', 'dateEdited']"
          [columnNameMapping]="documentForm?.options?.namedPlaceOptions?.listColumnNameMapping"
          lajiFormOption="options.namedPlaceOptions.listColumnNameMapping"
          [collectionID]="documentForm.collectionID"
          [formID]="documentForm.id"
          [namedPlace]="namedPlace.id"
          [showDownloadAll]="false"
          [admin]="formRights.admin"
          [forceLocalDocument]="useLocalDocumentViewer"
          [reload$]="reloadSubmissions$"
          (documentsLoaded)="onDocumentsLoaded($event)"
        ></laji-own-submissions>
      </div>
    </div>
  </ng-template>
</div>

node {
   nvm('v14.16.0') {
     stage('Prepare environment') {
      echo "test"
      echo "${env.ref}"
      if (env.ref != 'beta') {
        currentBuild.result = 'ABORTED'
      }
      cleanWs()
      git branch: 'beta', url: 'https://github.com/luomus/laji.git'
      sh 'npm ci'
      sh 'mkdir test-results'
      sh 'rm -rf test-results/*'
    }
    stage('Run integration tests') {
      if (currentBuild.result != 'ABORTED') {
        sh './node_modules/.bin/webdriver-manager clean'
        sh './node_modules/.bin/webdriver-manager update --versions.chrome=$(google-chrome --version | awk \'{print $3}\')'
        catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
          sh 'npm run e2e:ci -- --webdriver-update=false'
        }
        junit allowEmptyResults: true, testResults: '**/test-results/E2E/*.xml'
      }
    }
    stage('Build beta') {
      if (currentBuild.result != 'ABORTED') {
        milestone()
        sh 'rm -rf dist'
        sh 'npm run --silent build:ssr:beta'
        sh 'pre-compress-web-assets dist/browser'
        sh 'npm prune --silent --production'
        sh 'tar -cvzf beta.tar.gz --strip-components=1 dist node_modules'
      }
    }
    stage('Archive') {
      if (currentBuild.result != 'ABORTED') {
        milestone()
        archive 'beta.tar.gz'
      }
    }
  }
}

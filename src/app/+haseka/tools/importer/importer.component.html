<h3>
  Tallenna havaintoja massatallennuspohjalla
</h3>
<div class="row">
  <div class="col-sm-12">
    <p>
      Tällä sivulla voit tuoda massatallennuspohjaan tallennetut havainnot osaksi Vihkon havaintoja.
      Voit myös tuoda omia pohjia, kunhan niissä ensimmäinen rivi on otsikko rivi, joka kertoo mitä kenttä sisältää.
      Tunnistetut tiedosto fomaatit ovat Microsoft Excel Open XML Spreadsheet (xlsx), OpenDocument Text (odt) ja comma separated values file (csv).
      Yhdessä havaintoerässä saa olla maksimissaan {{maxUnits}} yksittäistä havaintoa.
    </p>
    <p>Havaintojen tallentaminen tapahtuu seuraavasti:</p>
  </div>
</div>


<div class="row data-container">
  <div class="col-sm-10">
    <span *ngIf="filename">Käsitellään tiedostoa: <strong>{{filename}}</strong></span>&nbsp;
  </div>
</div>

<div class="well">

  <laji-stepper [state]="status"
                (activate)="activate($event)"
                (title)="currentTitle = $event"
  ></laji-stepper>

  <h2>{{currentTitle}}</h2>

  <alert [type]="'danger'" *ngIf="status === 'fileAlreadyUploadedPartially'">
    <strong>Tiedosto on jo osittain ladattu.</strong> Poista tiedostosta rivit jotka ovat jo onnistuneesti tallenettu ja yritä uudelleen
  </alert>
  <alert [type]="'danger'" *ngIf="status === 'fileAlreadyUploaded'">
    <strong>Tiedosto on jo tallennettu.</strong> Varmista että valitsit oikean tiedoston.
  </alert>
  <alert [type]="'danger'" *ngIf="status === 'invalidFileType'">
    <strong>Virheellinen tiedosto formaatti.</strong> Tällä hetkellä tuettuina ovat vain Excel sekä OpenDocument formaatit.
  </alert>
  <alert [type]="'danger'" *ngIf="status === 'ambiguousColumns'">
    <strong>Otsikko rivullä usea samanniminen sarake!</strong>
    <br>Varmista että otsikko rivillä ei esiinny samaa nimeä useaan kertaan. Nyt löytyi sarakkeet "{{ambiguousColumns.join('", "')}}" useaan kertaan.
  </alert>
  <alert [type]="'danger'" *ngIf="status === 'doneWithErrors'">
    <strong>Kaikkea havaintoeriä ei onnistuttu tallentamaan!</strong>
  </alert>

  <ng-container *ngIf="['empty', 'importingFile', 'fileAlreadyUploaded', 'fileAlreadyUploadedPartially', 'invalidFileType', 'ambiguousColumns'].indexOf(status) > -1">
    <div><p>Valitse tiedosto alla olevaan kenttään. Jos tiedosto nimestä ei voinut päätellä Vihkon lomaketta, kysyy Vihko erikseen mitä lomaketta tulisi tallennuksessa käyttää.</p></div>
    <div class="row data-container">
      <div class="col-sm-8">
        <input type="file" class="form-control" (change)="onFileChange($event)" />
        <span *ngIf="fileLoading">Ladataan...</span>
      </div>
      <div class="col-sm-3 map-buttons">
        <div class="btn btn-default pull-right" *ngIf="hasUserMapping" (click)="clearUserMapping()" tooltip="Poista datan kuvaus" placement="left">
          <i class="glyphicon glyphicon-remove"></i>
        </div>
        <div class="btn btn-default pull-right" (click)="userMapModal.show()" tooltip="Tuo datan kuvaus" placement="left">
          <i class="glyphicon glyphicon-save"></i>
        </div>
      </div>
    </div>
    <div class="row data-container" *ngIf="!formID && !!bstr">
      <div class="col-sm-5">
        <laji-form-select [formID]="formID" (selected)="formSelected($event)"></laji-form-select>
      </div>
    </div>
  </ng-container>

  <laji-col-mapper
    *ngIf="status === 'colMapping'"
    (mappingDone)="colMappingDone($event)"
    [fields]="fields"
    [headers]="header"
    [colMapping]="colMap"
    (fieldSelected)="mapCol($event)"></laji-col-mapper>


  <laji-cell-value-mapping
    *ngIf="status === 'dataMapping'"
    (done)="rowMappingDone($event)"
    [fields]="fields"
    [data]="data"
    [colMapping]="colMap"></laji-cell-value-mapping>


  <ng-container *ngIf="status === 'importReady' || status === 'invalidData' || status === 'validating'">
    <div class="row">
      <div class="col-sm-9 spacer">
        <ng-container *ngIf="status === 'validating'">
          <laji-spinner [spinning]="status === 'validating'"></laji-spinner>
        </ng-container>
        <ng-container *ngIf="status === 'invalidData'">
          <p>
            Tiedoston datassa oli virheitä jotka estivät latauksen. Alla olevasta taulukosta löydät havaitut ongelmat.
            Voit tehdä tarvittavat korjaukset tiedostoon ja yrittää ladata se uudestaan suoraan tästä:
          </p>
          <div class="row">
            <div class="col-sm-8">
              <input type="file" class="form-control" (change)="onFileChange($event)" />
              <span *ngIf="fileLoading">Ladataan...</span>
            </div>
          </div>
        </ng-container>
        <ng-container *ngIf="status === 'importReady'">
          <button type="button" (click)="save(publ)" class="btn btn-success pull-right action">{{buttonLabel('save') | translate}}</button>
          <button type="button" (click)="save(priv)" class="btn btn-warning pull-right action">{{buttonLabel('temp') | translate}}</button>
          <div class="col-sm-3 map-buttons">
            <div class="btn btn-default pull-right" [class.disabled]="!hasUserMapping" (click)="showUserMapping()" tooltip="Nykyinen datan kuvaus" placement="left">
              <i class="glyphicon glyphicon-open"></i>
            </div>
          </div>
        </ng-container>
      </div>
    </div>

    <div class="data-container">
    <laji-datatable
        #dataTable
        class="import-table"
        [showRowAsLink]="false"
        [showFooter]="false"
        [virtualScrolling]="true"
        [clientSideSorting]="false"
        [height]="'50vh'"
        [rows]='mappedData'
        [count]="mappedData.length"
        [page]="1"
        [pageSize]="mappedData.length"
        [columns]="dataColumns">
      </laji-datatable>
    </div>
  </ng-container>

  <ng-container *ngIf="status === 'importing'">
    <h4>Tiedostoa ladataan</h4>
    Progress bar!
  </ng-container>

  <ng-container *ngIf="status === 'doneOk' || status === 'doneWithErrors'">
    <p *ngIf="status === 'doneOk'">
      Tiedosto tallennettiin onnistuneesti
    </p>
    <p *ngIf="status === 'doneWithErrors'">
      Alla olevasta taulukon ensimmäisestä sarakkeesta näet ne rivit joiden lähetys epäonnistui.
      Voit kokeilla uudelleen lähettämistä poistamalla tiedosta ne rivit joissa lähetys onnistui ja lähettämällä kyseinen tiedosto uudelleen.
      Jos ongelma ei korjaannut, niin ota yhteyttä ylläpitoon ja jos mahdollista, niin pistä ongelmallinen tiedosto myös mukaan.
    </p>
    <div class="data-container">
      <laji-datatable
        #dataTable
        class="import-table"
        [showRowAsLink]="false"
        [showFooter]="false"
        [virtualScrolling]="true"
        [clientSideSorting]="false"
        [height]="'50vh'"
        [rows]='mappedData'
        [count]="mappedData.length"
        [page]="1"
        [pageSize]="mappedData.length"
        [columns]="dataColumns">
      </laji-datatable>
    </div>
  </ng-container>

</div>

<ng-template let-rowIndex="rowIndex" #rowNumber>
  {{rowIndex + 2}}
</ng-template>

<ng-template let-value="value" let-column="column" #valueCol>
  <ng-container *ngIf="column.externalLabel; else valueAsIs">
    {{value | label:'withKey' | values:separator}}
  </ng-container>
  <ng-template #valueAsIs>{{value | values:separator}}</ng-template>
</ng-template>

<ng-template let-value="value" #statusCol>
  <laji-status-cell [value]="value" [fields]="fields"></laji-status-cell>
</ng-template>

<div class="modal fade" bsModal #userMapModal="bs-modal" tabindex="-1" role="dialog"
     aria-labelledby="column and value mapping" aria-hidden="true">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <div class="modal-body mapping-body">
        <button type="button" class="close pull-right" aria-label="Close" (click)="userMapModal.hide()">
          <span aria-hidden="true">&times;</span>
        </button>
        <h1>
          Kuvauksen tuonti
        </h1>
        <p>Voit kopioida alla olevaan kenttään laji.fi:n ymmärtämän kuvauksen datastasi.</p>
        <p>
          Kuvauksen voi tehdä ladattuasi haluamasi massatallennuspohjan laji.fi:hin.
        </p>
        <textarea rows="10" #userMapping class="form-control"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" tabindex="-1" class="btn btn-primary btn-sm" (click)="useUserMapping(userMapping.value)">Käytä</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" bsModal #currentUserMapModal="bs-modal" tabindex="-1" role="dialog"
     aria-labelledby="column and value mapping" aria-hidden="true">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <div class="modal-body mapping-body">
        <button type="button" class="close pull-right" aria-label="Close" (click)="currentUserMapModal.hide()">
          <span aria-hidden="true">&times;</span>
        </button>
        <h1>
          Datan nykyinen kuvaus
        </h1>
        <p>
          Ottamalla talteen tämän kuvauksen, voit tuoda jatkossa samanmuotoista dataa ilman, että sinun tarvitsee
          uudelleen kertoa mistä arvoissa on kyse.
        </p>
        <textarea rows="10" class="form-control">{{userMappings | json}}</textarea>
      </div>
    </div>
  </div>
</div>

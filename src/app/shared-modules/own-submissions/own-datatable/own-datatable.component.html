<ng-container *ngIf="visibleRows">
  <div id="filter-row-container" class="row">
    <div class="col-sm-12">
      <div id="download-button-container" *ngIf="showDownloadAll">
        <button type="button" class="btn btn-default inline-block" (click)="openChooseFileTypeModal()">
          <span><i class="glyphicon glyphicon-download-alt"></i> {{ "haseka.submissions.download" | translate }} {{ "haseka.submissions.submissions" | translate }}</span>
        </button>
      </div>

      <div class="print-actions" *ngIf="showPrintLabels">
        <button *ngIf="printState === 'none'" type="button" class="btn btn-default inline-block" (click)="doLabels()">
          <span><i class="glyphicon glyphicon-qrcode"></i> {{ 'label.select.label' | translate }}</span>
        </button>
        <button *ngIf="printState === 'select'" type="button" class="btn btn-success inline-block" (click)="doLabels()" [disabled]="!selected || selected.length === 0">
          <span><i class="glyphicon glyphicon-qrcode"></i> {{ 'label.make' | translate }}</span>
        </button>
      </div>

      <div *ngIf="printState === 'select'" class="print-actions text-block" [innerHtml]="'label.select.intro' | translate">
      </div>

      <input class="form-control inline-block"
             type='text'
             placeholder="{{'haseka.submissions.filter' | translate}}"
             (keyup)='updateFilter($event)'/>
    </div>
  </div>
  <ngx-datatable
    class="material striped"
    [cssClasses]="{
      sortAscending: 'glyphicon glyphicon-chevron-down',
      sortDescending: 'glyphicon glyphicon-chevron-up',
      pagerLeftArrow: 'glyphicon glyphicon-chevron-left',
      pagerRightArrow: 'glyphicon glyphicon-chevron-right',
      pagerPrevious: 'glyphicon glyphicon-step-backward',
      pagerNext: 'glyphicon glyphicon-step-forward'
    }"
    [selectionType]="selectionType"
    (select)='onSelect($event)'
    [selectAllRowsOnPage]="false"
    [rows]="visibleRows"
    [rowIdentity]="rowIdentity"
    [externalSorting]="true"
    [sorts]="defaultSort"
    [columnMode]="'flex'"
    [headerHeight]="38"
    [rowHeight]="'auto'"
    [limit]="20"
    [footerHeight]="30"
    [messages]="{emptyMessage: loadError, totalMessage: totalMessage}"
    (sort)="onSort($event)"
  >

    <ngx-datatable-row-detail [rowHeight]="'auto'">
      <ng-template let-row="row" ngx-datatable-row-detail-template>
        <div *ngFor="let col of useColumns | filterColumns:this.displayMode:true" style="padding-left: 35px">
          <span><strong>{{ 'haseka.submissions.' + col.prop | translate }}: </strong></span>
          <span>{{ row[col.prop] }}</span>
        </div>
      </ng-template>
    </ngx-datatable-row-detail>

    <ngx-datatable-column
      *ngIf="!!selectionType"
      [width]="30"
      [sortable]="false"
      [canAutoResize]="false"
      [draggable]="false"
      [resizeable]="false"
      [headerCheckboxable]="true"
      [checkboxable]="true">
    </ngx-datatable-column>

    <ngx-datatable-column [flexGrow]="1" [resizeable]="false"
                          [draggable]="false" *ngIf="displayMode !== 'large'" [headerClass]="'empty-header'">
      <ng-template ngx-datatable-header-template><span></span></ng-template>
      <ng-template let-row="row" ngx-datatable-cell-template>
        <span class="link">
          <i class="glyphicon"
            [ngClass]="{'glyphicon-chevron-right': !row.$$expanded, 'glyphicon-chevron-down': row.$$expanded}"
            (click)="toggleExpandRow(row)"></i>
        </span>
      </ng-template>
    </ngx-datatable-column>

    <ngx-datatable-column *ngIf="actions" [prop]="'publicity'" [name]="'haseka.submissions.publicity' | translate" [cellClass]="'center-text'"
                          [flexGrow]="1" [resizeable]="false" [draggable]="false" [headerClass]="'empty-header'" ngPreserveWhitespaces>
      <ng-template let-column="column" let-sort="sortFn" ngx-datatable-header-template>
        <span class="datatable-header-cell-wrapper link"><span></span></span>
      </ng-template>
      <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
        <span *ngIf="actions.indexOf('view') > -1 && onlyTemplates === false && value === publicity.publicityRestrictionsPublic">
          <span class="label label-success link inline-block"
                [tooltip]="'result.showViewer' | translate"
                [placement]="'right'"
                container="body"
                [adaptivePosition]="false"
                (click)="showViewer(row.id)">
            <i class="glyphicon glyphicon-eye-open"></i>
          </span>
        </span>
        <span *ngIf="actions.indexOf('view') > -1 && onlyTemplates === false && value === publicity.publicityRestrictionsPrivate">
          <span class="label label-warning link inline-block"
                [tooltip]="'result.showPrivateViewer' | translate"
                [placement]="'right'"
                container="body"
                [adaptivePosition]="false"
                (click)="showViewer(row.id)">
            <i class="glyphicon glyphicon-eye-close"></i>
          </span>
        </span>
        <a *ngIf="actions.indexOf('edit') > -1" class="label label-primary link inline-block"
              [ngClass]="{
                'label-primary': !row.locked,
                'label-default': row.locked
              }"
              [tooltip]="(onlyTemplates ? 'template.use' : 'haseka.submissions.toEdit') | translate"
              container="body"
              [adaptivePosition]="false"
              [routerLink]="row._editUrl | localize"
              [placement]="'right'">
            <i class="glyphicon glyphicon-edit"></i>
        </a>
        <span *ngIf="showMakeTemplate(row)">
          <span class="label label-warning link inline-block"
                (click)="makeTemplate(row)"
                [tooltip]="'haseka.form.saveTemplate' | translate"
                container="body"
                [adaptivePosition]="false"
                [placement]="'right'">
            <i class="glyphicon glyphicon-floppy-disk"></i>
          </span>
        </span>
      </ng-template>
    </ngx-datatable-column>

    <ngx-datatable-column *ngFor="let col of useColumns | filterColumns:this.displayMode"
                          [prop]="col.prop"
                          [resizeable]="false"
                          [draggable]="false"
                          [name]="(columnNameMapping && columnNameMapping[col.prop])
                                  ? columnNameMapping[col.prop]
                                  : 'haseka.submissions.' + col.prop | translate"
                          [flexGrow]="3"
                          [cellClass]="'break-word'">
      <ng-template let-column="column" let-sort="sortFn" ngx-datatable-header-template>
        <span class="datatable-header-cell-wrapper"
              (click)="sort()"
              title="{{column.name}}">
          <span class="datatable-header-cell-label draggable">
            {{ column.name }}
          </span>
        </span>
      </ng-template>
    </ngx-datatable-column>

    <ngx-datatable-column *ngIf="actions && (actions.indexOf('download') > -1 || actions.indexOf('stats') > -1 || actions.indexOf('delete') > -1)" [flexGrow]="1" [draggable]="false" [resizeable]="false" [cellClass]="'center-text'">
      <ng-template ngx-datatable-header-template><span></span></ng-template>
      <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
        <div ngPreserveWhitespaces>
          <span *ngIf="actions.indexOf('download') > -1 && onlyTemplates === false" class="label label-default link inline-block"
                [tooltip]="('haseka.submissions.download' | translate) + ' ' + ('haseka.submissions.submission' | translate)"
                [placement]="'left'"
                [container]="'body'"
                [adaptivePosition]="false"
                (click)="openChooseFileTypeModal(row.id)">
            <i class="glyphicon glyphicon-download-alt"></i>
          </span>
          <a *ngIf="actions.indexOf('stats') > -1 && row.formViewerType === 'MHL.viewerTypeLineTransect'"
                class="label label-warning link inline-block"
                [tooltip]="'haseka.submissions.toStatistics' | translate"
                [placement]="'left'"
                [container]="'body'"
                [adaptivePosition]="false"
                [routerLink]="'/theme/linjalaskenta/statistics/' + row.id | localize">
            <i class="glyphicon glyphicon-stats"></i>
          </a>
          <span *ngIf="actions.indexOf('delete') > -1 && (admin ||Â row.creator === usersId)" class="label label-danger link inline-block"
                [tooltip]="'friend.remove' | translate"
                [placement]="'left'"
                [adaptivePosition]="false"
                [container]="'body'"
                (click)="deleteDialog(row)">
            <i class="glyphicon glyphicon-remove"></i>
          </span>
        </div>
      </ng-template>
    </ngx-datatable-column>
  </ngx-datatable>
</ng-container>

<div class="modal" tabindex="-1" role="dialog" bsModal #chooseFileTypeModal="bs-modal">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <button class="close pull-right" type="button" (click)="modal.hide()">
          <i class="glyphicon glyphicon-remove"></i>
        </button>
        <h4>{{ 'haseka.submissions.chooseFormat' | translate }}</h4>
      </div>
      <div class="modal-body">
        <div>
          <div class="radio">
            <label><input type="radio" name="optradio" [(ngModel)]="fileType" value="csv">.csv</label>
          </div>
          <div class="radio">
            <label><input type="radio" name="optradio" [(ngModel)]="fileType" value="tsv">.tsv</label>
          </div>
          <div class="radio">
            <label><input type="radio" name="optradio" [(ngModel)]="fileType" value="ods">.ods</label>
          </div>
          <div class="radio">
            <label><input type="radio" name="optradio" [(ngModel)]="fileType" value="xlsx">.xlsx</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" (click)="download.emit({fileType: fileType, documentId: downloadedDocumentId})">
          <span>{{ "haseka.submissions.download" | translate }}</span>
        </button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal" tabindex="-1" role="dialog" bsModal #saveAsTemplate="bs-modal">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <button class="close pull-right" type="button" (click)="templateModal.hide()">
          <i class="glyphicon glyphicon-remove"></i>
        </button>
        <h4 class="modal-title">{{ 'template.formTitle' | translate }}</h4>
      </div>
      <div class="modal-body">
        <label for="templateName">{{ 'template.name' | translate }}: <span class="required">*</span></label>
        <input id="templateName" class="form-control" type="text" [(ngModel)]="templateForm.name" name="name">
        <label for="templateDescription">{{ 'template.description' | translate }}:</label>
        <textarea id="templateDescription" class="form-control" [(ngModel)]="templateForm.description" name="description"></textarea>
        <!--
        <div>
          <label>{{'template.chooseType' | translate}}</label>
          <div class="radio">
            <label><input type="radio" name="templateType" [(ngModel)]="templateForm.type" value="gathering">{{'template.saveGathering' | translate}}</label>
          </div>
          <div class="radio">
            <label><input type="radio" name="templateType" [(ngModel)]="templateForm.type" value="unit">{{'template.saveUnit' | translate}}</label>
          </div>
        </div>
        -->
        <span class="required">*</span> = {{ 'required' | translate }}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" [class.disabled]="templateForm.name.length === 0" (click)="saveTemplate()">
          <span>{{ "np.save" | translate }}</span>
        </button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal" tabindex="-1" role="dialog" bsModal #deleteModal="bs-modal">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <button class="close pull-right" type="button" (click)="deleteModal.hide()">
          <i class="glyphicon glyphicon-remove"></i>
        </button>
        <h4 class="modal-title" [innerHtml]="(onlyTemplates ? 'haseka.delete.template' : 'haseka.delete.description') | translate:{id: deleteRow?.id, name: deleteRow?.templateName}"></h4>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success pull-left" [disabled]="deleting" (click)="deleteModal.hide()">
          <span>{{ "haseka.delete.cancel" | translate }}</span>
        </button>
        <button type="button" class="btn btn-danger" [disabled]="deleting" (click)="deleteDocument()">
          <span>{{ "haseka.delete.ok" | translate }}</span>
        </button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
